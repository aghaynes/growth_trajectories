packages:
  - callr
  - baad.data
  - rmarkdown
  - plant
  - xtable
  - RColorBrewer
  - dplyr
  - knitr
  - parallel
  - rstan

sources:
  - R

plot_options:
  tall:
    width: 4
    height: 12
  wide:
    width: 12
    height: 4
  3x2:
    width: 9
    height: 6
  square:
    width: 6
    height: 6
  med_square:
    width: 9
    height: 9
  large_square:
    width: 12
    height: 12

include:
  - remake_figures_plant.yml

targets:
  all:
    depends:
      - ms/ms.pdf

# Documents ------------------------

  ms/ms.pdf:
    command: latex_build("ms/ms.tex", bibliography="ms/references.bib")
    depends:
      - output/main/table-pars.tex
      - output/main/figure_conceptual.pdf
      - output/main/lcp_schematic.pdf
      - output/main/assumptions.pdf
      - output/main/growth_light_height.pdf
      - output/main/lcp_trait.pdf
      - ms/ms-supp.pdf

  ms/ms-supp.pdf:
    command: latex_build("ms/ms-supp.tex", bibliography="ms/references.bib", clean=FALSE)
    # Don't clean because we need info for cross references
    depends:
      - output/SI/lma_tradeoff.pdf
      - output/SI/growth_light_dia.pdf
      - output/SI/growth_light_mass.pdf
      - output/SI/growth_light_area.pdf

  ms/ms-supp.tex:
    knitr: TRUE

# Data ------------------------
  glopnet:
    command: >
      process_wright_2004("downloads/wright_2004.xls",
                          glopnet_locations)
    packages: xlsx

  downloads/wright_2004.xls:
    download: http://www.nature.com/nature/journal/v428/n6985/extref/nature02403-s2.xls
    cleanup_level: purge
    check: exists

  glopnet_locations:
    command: read.csv("data/wright_2004_locations.csv")

# Tables & figures ------------------------

  output/main/figure_conceptual.pdf:
    command: latex_build("ms/figure_conceptual.tex", output=target_name, engine=I("xelatex"))
    depends:
      - output/con/net_mass_production_dt_net_mass_production_dt.pdf
      - output/con/mass_total_dt_mass_total_dt.pdf
      - output/con/darea_leaf_dmass_live_darea_leaf_dmass_live.pdf
      - output/con/height_dt_height_dt.pdf
      - output/con/area_leaf_dt_area_leaf_dt.pdf
      - output/con/area_stem_dt_area_stem_dt.pdf
      - output/con/diameter_stem_dt_diameter_stem_dt.pdf
      - output/main/mass_fraction.pdf

  output/main/assumptions.pdf:
    command: figure_assumptions(fit_a.lf_h.t, fit_a.lf_sap, fit_a.lf_m.rf, fit_h.t_msal)
    plot: med_square

  fit_a.lf_h.t:
    command: fit_SMA_baad(I("a.lf"), I("h.t"))
    check: exists

  fit_a.lf_m.rf:
    command: fit_SMA_baad(I("a.lf"), I("m.rf"))
    check: exists

  fit_a.lf_sap:
    command: fit_SMA_baad(I("a.lf"), I("sap"))
    check: exists

  fit_h.t_msal:
    command: fit_SMA_baad(I("h.t"), I("msal"))
    check: exists

  fit_lma_tradeoff:
    command: fit_SMA_lma(glopnet)
    check: exists

  output/SI/lma_tradeoff.pdf:
    command: figure_lma_tradeoff(glopnet, fit_lma_tradeoff)
    plot: square
